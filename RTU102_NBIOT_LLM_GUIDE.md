# RTU102 NB-IoT: инструкция для LLM по протоколу TELEOFIS RTU

Документ основан на спецификации: `USPD-TELEOFIS-RTU.-Protokol-peredachi-dannykh-r.1.13-_2025_02_14_.pdf` (ревизия `r.1.13`, дата `2025-02-14`).

## 1. Профиль текущего кейса

- Устройство: `RTU102` в сети `NB-IoT`.
- Транспорт: `UDP`.
- Известно: `IMEI` устройства, `PIN устройства` (доступ к настройкам).
- Неизвестно: `PIN SIM-карты`.
- Ключ шифрования можно задать вручную в конфигураторе (локально, через USB).

Ключевой вывод для LLM:
- `PIN устройства` и `PIN SIM-карты` - это разные сущности.
- Без корректного `PIN SIM` (если SIM его требует) устройство в сеть не зарегистрируется.
- Ключ шифрования настраивается локально и должен совпадать у устройства и сервера.
- Формат RTU-пакета (`0xC0...0xC2`, XTEA, CRC) одинаковый; в вашем профиле передача идет UDP-датаграммами.

## 2. Базовая модель протокола

### 2.1. Обрамление кадра

Каждый пакет на линии:
- старт: `0xC0`
- конец: `0xC2`
- между ними: `IMEI (8 байт) + зашифрованные данные`

### 2.2. Байт-стаффинг

Применяется внутри кадра (между `0xC0` и `0xC2`):
- `0xC0 -> 0xC4 0xC1`
- `0xC2 -> 0xC4 0xC3`
- `0xC4 -> 0xC4 0xC4`

При разборе выполнять обратную замену.

### 2.3. IMEI в пакете

- Передается как `uint64 little-endian` (8 байт), не ASCII-строка.
- Преобразование: `imei_bytes = int(imei_decimal).to_bytes(8, 'little')`.

### 2.4. Шифрование

- Алгоритм: `XTEA`, ключ `128 бит (16 байт)`, режим `ECB`.
- Блок: `8 байт`.
- Для совместимости с примером из документа:
  - 32 раунда XTEA;
  - блок трактуется как `2 x uint32 little-endian`;
  - ключ трактуется как `4 x uint32 little-endian`.

### 2.5. CRC

- CRC: `CRC-16 CCITT` (`poly=0x1021`, `init=0xFFFF`, без xorout), little-endian в пакете.
- Контрольная сумма считается по: `[полезные данные + нулевая добивка]`.
- Последние 2 байта расшифрованного блока - CRC.

### 2.6. Дополнение до кратности 8

Порядок формирования расшифрованного блока перед шифрованием:
1. Сформировать `payload`.
2. Добавить нули **до CRC**, чтобы выполнялось `(len(payload) + pad + 2) % 8 == 0`.
3. Посчитать CRC по `payload + pad`.
4. Добавить CRC (2 байта, little-endian).

Формула:
`pad_len = (8 - ((len(payload) + 2) % 8)) % 8`

### 2.7. Транспортный профиль UDP

- Одна UDP-датаграмма должна содержать один полный RTU-кадр (`0xC0 ... 0xC2`).
- Для RTU102 формат полезной нагрузки не меняется из-за UDP: меняется только транспортный слой.
- Сервер разбирает каждый datagram независимо (без stream-буфера, как в TCP).
- Ответы отправляются на `source IP:source port` datagram, от которого получен пакет устройства.

## 3. Конвейер разбора входящего пакета (device -> server)

1. Проверить границы `0xC0 ... 0xC2`.
2. Убрать байт-стаффинг.
3. Первые 8 байт извлечь как IMEI (`uint64 little-endian`).
4. Остаток расшифровать XTEA-ECB.
5. Отделить последние 2 байта как `crc_recv`.
6. Проверить `crc_recv == CRC16(plain_without_crc)`.
7. Разбирать `plain_without_crc` как последовательность блоков данных протокола.
8. Хвостовые нули считать padding (если они не потреблены структурами данных).

## 4. Конвейер формирования ответа (server -> device)

1. Сформировать `payload` (один или несколько блоков данных).
2. Добавить нулевую добивку по формуле выше.
3. Добавить CRC16 little-endian.
4. Зашифровать XTEA-ECB.
5. Сформировать тело кадра: `imei_8_bytes + encrypted`.
6. Применить байт-стаффинг.
7. Обернуть: `0xC0 + stuffed + 0xC2`.

## 5. Идентификаторы данных (внутри расшифрованного payload)

- `1` - команда настройки устройства
- `2` - ответ на команду настройки
- `3` - пакет событий/архива
- `4` - подтверждение пакета архива
- `5` - прозрачный канал (не основной сценарий для RTU102)
- `6` - команда чтения настроек
- `7` - ответ на команду чтения
- `8` - авторизация на сервере при отключенной спорадике (формат в документе не раскрыт подробно)
- `9` - телеметрия
- `10..14` - расширенные команды RTU800 (для RTU102 не применять)

## 6. Форматы полезных данных

### 6.1. ID=1 (команда настройки)

`[param_id:1][len:1][data:len]`

### 6.2. ID=2 (ответ на команду настройки)

`[param_id:1][result_code:1]`

Коды `result_code`:
- `0` - выполнено
- `1` - команда не поддерживается
- `2` - неверный формат данных
- `3` - ошибка
- `4` - команда заблокирована

### 6.3. ID=6 (команда чтения настроек)

`[param_id:1][len:1][data:len]`

Практически для обычного чтения: `len=0`, `data` пусто.

### 6.4. ID=7 (ответ на чтение)

`[param_id:1][result_code:1][len:1][data:len]`

### 6.5. ID=9 (телеметрия)

`[count:1][param_id:1][len:1][data:len]...` (повтор `count` раз)

### 6.6. ID=3 (архив/события)

Общий формат:
- `[seq:1]` - номер пакета
- далее один или несколько event-блоков

Event-блок:
- `[event_code:1][event_time_unix:4][event_data_len:1][event_data:event_data_len]`

`event_data` содержит набор записей вида `[type_id:1][typed_value:var]`.
Длины `typed_value` берутся из таблицы типов данных (ниже минимум для RTU102).

### 6.7. ID=4 (подтверждение архива)

`[seq:1]`

Сервер должен отправлять такой ack на каждый принятый пакет ID=3.

## 7. Сеанс обмена (типовой для UDP)

1. Устройство само инициирует обмен и отправляет UDP-пакет на сервер.
2. Устройство отправляет телеметрию (`ID=9`).
3. Сервер отправляет подтверждение телеметрии (`ID=9` без данных).
4. Сервер обычно отправляет:
- установку времени (`ID=1`, параметр `1`)
- при необходимости другие команды
- команду окончания запросов (`ID=1`, параметр `55`), чтобы устройство быстрее ушло в сон
5. Устройство отправляет архив событий (`ID=3`, несколько пакетов).
6. Сервер подтверждает каждый архивный пакет (`ID=4` с номером пакета).

Из документа:
- если не отправить команду завершения запросов, устройство держит связь около 2 минут,
- после каждой команды от сервера добавляется еще ~20 секунд окна связи.

Для UDP-профиля:
- трактуйте это как "окно активности" модема, а не TCP-сессию;
- ответы (`ack` и команды) отправляйте без задержки в тот же `IP:port`, откуда пришел пакет;
- учитывайте возможные дубликаты/потери UDP и делайте обработчики `ID=3/ID=4` идемпотентными по `IMEI + seq`.

## 8. Ключевые события и типы данных (RTU102)

### 8.1. Основные `event_code`

- `1` - событие по времени
- `2` - событие по АЦП (обрыв/КЗ)
- `3` - рестарт
- `4` - сработал сухой контакт
- `8` - нажата кнопка
- `10` - начало/конец обучения
- `11` - обучен один из контактов
- `12` - ошибка сеанса связи
- `15` - превышение частоты импульсов
- `16` - конец передачи архива
- `17` - превышен период отсутствия связи на SIM

### 8.2. Часто используемые `type_id` в `event_data`

- `0..3` - счетчики 1..4 (по 4 байта)
- `6` - количество рестартов (4 байта)
- `7..10` - состояние входов 1..4 (по 1 байту)
- `20` - код ошибки связи (1 байт)
- `22` - номер входа при превышении частоты импульсов (1 байт)
- `23` - номер SIM с ошибкой (1 байт)
- `24` - номер SIM с превышением периода бездействия (1 байт)

Коды ошибки связи (`type_id=20`):
- `0` - без ошибок
- `1` - неверный PIN
- `2` - SIM не вставлена
- `3` - не удалось зарегистрироваться в сети
- `4` - не удалось подключиться по GPRS
- `5` - нет соединения с сервером

## 9. Важные параметры для RTU102 NB-IoT

Ниже параметры обычных команд (`ID=1/6`, 1-байтовый номер параметра).

| Параметр (dec/hex) | R/W | Длина | Назначение |
|---|---|---:|---|
| `1 / 0x01` | R/W | 4 | Текущее время (Unix time) |
| `3 / 0x03` | R/W | 4 (строка) | PIN SIM 1 |
| `4 / 0x04` | R/W | до 32 | APN |
| `5 / 0x05` | R/W | до 32 | Логин APN |
| `6 / 0x06` | R/W | до 32 | Пароль APN |
| `7 / 0x07` | R/W | до 32 | Адрес сервера |
| `8 / 0x08` | R/W | до 8 | Порт сервера (ASCII-цифры) |
| `10 / 0x0A` | Local only | 16 | Ключ шифрования (только через USB/конфигуратор) |
| `11 / 0x0B` | R | 16 | IMEI модема |
| `13 / 0x0D` | R | 16 | Версия ПО |
| `35 / 0x23` | R/W | 1 | Активная SIM (`0`/`1`) |
| `41 / 0x29` | R | 1 | Состояние SIM (`0..3`) |
| `42 / 0x2A` | R | 1 | Регистрация в сети (`0/1`) |
| `43 / 0x2B` | R | 1 | Состояние GPRS/PDP (`0/1`) |
| `44 / 0x2C` | R | 1 | Соединение с сервером (`0/1`) |
| `48 / 0x30` | R/W | 1 | Часовой пояс |
| `50 / 0x32` | R/W | 8 | Маска параметров телеметрии |
| `55 / 0x37` | W | 1 | Команда окончания запросов с сервера (`0`) |
| `69 / 0x45` | R/W | 1 | Отключение спорадических сообщений (`1`=выкл) |
| `70 / 0x46` | R/W | 4 (строка) | PIN SIM 2 |
| `78 / 0x4E` | R/W | 2 | Макс. время регистрации в сети (сек) |
| `100 / 0x64` | W | 32 | Установка пароля на смену настроек |
| `101 / 0x65` | W | 32 | Блокировка/разблокировка смены настроек |
| `102 / 0x66` | R | 1 | Статус блокировки (`0/1`) |
| `116 / 0x74` | R | 32 | Имя оператора SIM1 (NB-IoT) |
| `126 / 0x7E` | R | 8..128 | Строка состояния сети (NB-IoT) |
| `131 / 0x83` | R/W | 16 | NB-IoT Band mask для модема BC95-G |
| `144 / 0x90` | R/W | 16 | NB1 Band mask для SIM1 (BG96) |
| `148 / 0x94` | R | 1 | Текущая сеть (`0` нет, `1` NB1, `2` M1, `3` GSM) |
| `150 / 0x96` | W | 16 | Установка пользовательского пароля доступа |
| `151 / 0x97` | W | 16 | Ввод пароля доступа к настройкам |

## 10. NB-IoT диагностика (параметр 126)

Параметр `126` - CSV-строка фиксированного порядка. Пример:
`-808,-777,230,199168,0,167,3754,1,-108`

Поля по позиции:
1. Уровень сигнала (десятые доли дБ)
2. Общая мощность (десятые доли дБ)
3. Текущая мощность передачи (десятые доли дБ)
4. Cell ID
5. Enhanced coverage level (`0/1/2` -> `0/10/20 dB`)
6. SNR (десятые доли дБ)
7. EARFCN
8. PCI
9. RSRQ (десятые доли дБ)

## 11. Практика для вашего случая (без PIN SIM)

### 11.1. Безопасная стартовая последовательность

1. Локально в конфигураторе задать ключ XTEA (16 байт).
2. На сервере привязать тот же ключ к IMEI.
3. При первом пакете от устройства проверить, что IMEI совпадает с ожидаемым.
4. Сразу отправить подтверждение телеметрии (`ID=9`).
5. Прочитать диагностические параметры: `41, 42, 43, 44, 116, 126, 148, 13`.
6. Если включена блокировка настроек (`102=1`), сначала ввести PIN устройства через `param 151`.
7. Настройки (APN/сервер/время/маска) менять только после успешной диагностики.

### 11.2. Что делать, если нет PIN SIM

- Если `param 41 == 1` (SIM требует PIN), без PIN SIM дальнейшая регистрация в сети невозможна.
- PIN устройства (`param 151`) не заменяет PIN SIM (`param 3/70`).
- Нужен один из вариантов:
  - получить PIN SIM у оператора,
  - либо снять проверку PIN на SIM вне устройства.

## 12. Эталонные примеры из документа (до шифрования)

### 12.1. Подтверждение телеметрии

`09 00 00 00 00 00 F2 46`

Смысл:
- `09` - ID подтверждения телеметрии
- `00..00` - padding
- `F2 46` - CRC16 little-endian

### 12.2. Команда установки времени

`01 01 04 1E CB 4C 59 00 00 00 00 00 00 F5 89`

Смысл:
- `01` - ID команды настройки
- `01` - параметр времени
- `04` - длина
- `1E CB 4C 59` - Unix time (LE)
- далее padding и CRC

### 12.3. Команда завершения запросов

`01 37 01 00 00 00 3E 56`

## 13. Минимальные функции для реализации (псевдокод)

```python
def crc16_ccitt_false(data: bytes) -> int:
    crc = 0xFFFF
    for b in data:
        crc ^= (b << 8)
        for _ in range(8):
            if crc & 0x8000:
                crc = ((crc << 1) ^ 0x1021) & 0xFFFF
            else:
                crc = (crc << 1) & 0xFFFF
    return crc


def build_plain(payload: bytes) -> bytes:
    pad_len = (8 - ((len(payload) + 2) % 8)) % 8
    body = payload + b"\x00" * pad_len
    crc = crc16_ccitt_false(body)
    return body + crc.to_bytes(2, "little")


def imei_to_8_bytes(imei_decimal: str) -> bytes:
    return int(imei_decimal).to_bytes(8, "little", signed=False)
```

## 14. Ограничения и оговорки

- Формат `ID=8` (авторизация при отключенной спорадике) в этой ревизии описан неполно. Если используете `param 69=1`, закладывайте отдельную валидацию с тестами на реальном устройстве.
- В документе явное упоминание `TCP` встречается в разделах прозрачного канала для RTU602/RTU800; для базовой RTU102-интеграции применяйте описанный выше UDP-профиль.
- Расширенные команды `ID=10..14` нужны RTU800, не использовать для RTU102.

## 15. Шаблон системного промпта для LLM-агента

```text
Ты серверный агент протокола TELEOFIS RTU (RTU102 NB-IoT).

Правила:
1) Всегда проверяй frame boundaries (0xC0...0xC2), unstuffing, IMEI(8B LE), XTEA-ECB, CRC16-CCITT.
2) Любой исходящий пакет строится как payload + zero-pad + CRC, затем XTEA, затем stuffing.
3) Все числа little-endian.
4) Для каждой команды показывай:
   - расшифрованный payload (hex),
   - pad_len,
   - CRC (hex),
   - итоговый кадр (hex).
5) Не путай PIN устройства и PIN SIM.
6) Если SIM status=1 (нужен PIN SIM), запрашивай PIN SIM и не продолжай сетевую диагностику как "исправную".
7) Не пытайся менять key шифрования по сети (param 10 - локальный/USB).
8) Для RTU102 не используй расширенные команды RTU800 (ID 10..14).
9) Работай в UDP-профиле: 1 datagram = 1 RTU frame, ответы всегда отправляй на source IP:source port.
```
